# Architectural Review & Improvement Plan (2026-02-02)

## 1. Current State Assessment

The Pointline architecture is a high-performance, point-in-time (PIT) accurate data engine built on Polars and Delta Lake. It successfully separates domain logic from orchestration and persistence.

### Strengths
*   **Decoupled Design:** Clear separation between `tables` (logic), `services` (orchestration), and `io` (storage).
*   **Performance:** Extensive use of Polars for vectorized operations and fixed-point encoding for storage efficiency.
*   **Integrity:** Strong emphasis on symbol resolution correctness and timezone-aware partitioning.

## 2. Identified Weaknesses

| Area | Issue | Impact |
| :--- | :--- | :--- |
| **Boilerplate** | `Trades` and `Quotes` ingestion services have ~80% code duplication. | Higher maintenance, harder to add new data types. |
| **Vendor Coupling** | Tardis-specific parsing is hardcoded into domain table modules. | Difficult to support new data sources (e.g., Binance, OKX). |
| **DQ Observability** | Validation results are logged but not persisted to the lake. | No queryable audit trail for lake health or reproducibility. |
| **Schema Management**| Schemas are scattered across multiple modules. | Risk of drift between code and physical Delta tables. |

## 3. Recommended Improvements

### Phase 1: Ingestion Refactoring
*   **Task:** Create a `GenericIngestionService` in `pointline/services/base_service.py`.
*   **Goal:** Move common logic (file reading, quarantine, lineage, metadata) into a shared base, reducing specific services to configuration only.

### Phase 2: DQ Persistence
*   **Task:** Integrate `pointline/tables/validation_log.py` into the `BaseService` pipeline.
*   **Goal:** Automatically write ingestion metrics (row counts, errors, duration) to a Silver `validation_log` table.

### Phase 3: Vendor Decoupling
*   **Task:** Extract `parse_tardis_*` functions from `pointline/tables/` to `pointline/io/parsers/tardis.py`.
*   **Goal:** Keep domain logic pure and make the system source-agnostic.

### Phase 4: Centralized Schema Registry
*   **Task:** Consolidate all table schemas into a central registry or metadata system.
*   **Goal:** Enable automated documentation, testing, and schema-evolution validation.
